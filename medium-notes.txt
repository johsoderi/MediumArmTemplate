--- Command Begin ------------------------------------

az login
$BaseName = "MediumARMtemplate"
$AdminPassword = Read-Host -Prompt "Choose a password for user 'ServerAdmin':" -AsSecureString
$RG = $BaseName + 'RG'
$Loc = "North Europe"

New-AzResourceGroup -Name $RG -Location $Loc -Force 
New-AzResourceGroupDeployment -name $BaseName+'Deployment' -ResourceGroupName $RG `
    -TemplateFile C:\Users\JohannesSöderbergEri\Documents\MediumArmTemplate\MainTemplate.json `


--- Command End --------------------------------------

ServerTemplate Parameters som bör skickas in:
	virtualMachineName
	publicIpAddressName
	

Test-AzResourceGroupDeployment -virtualMachineName WebServer1 -publicIpAddressName webserver1-ip -ResourceGroupName mediumARMTemplateRG `
  -TemplateFile C:\Users\JohannesSöderbergEri\Documents\MediumArmTemplate\ServerTemplate.json `
  -TemplateParameterFile C:\Users\JohannesSöderbergEri\Documents\MediumArmTemplate\ServerTemplate.parameters.json

New-AzResourceGroupDeployment -name WebServer1 -virtualMachineName WebServer1 -publicIpAddressName webserver1-ip -ResourceGroupName mediumARMTemplateRG `
>>   -TemplateFile C:\Users\JohannesSöderbergEri\Documents\MediumArmTemplate\ServerTemplate.json `
>>   -TemplateParameterFile C:\Users\JohannesSöderbergEri\Documents\MediumArmTemplate\ServerTemplate.parameters.json



För att göra nested templates måste man välja att köra parameterfil eller inline(?). Ta bort alla parametrar som inte ändras så det
räcker att skicka in:
	virtualMachineName
	publicIpAddressName
	networkInterfaceName

https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/linked-templates



Create SecureString:
	$SecurePassword = Read-Host -Prompt "Enter password" -AsSecureString 

Create Key Vault:
	New-AzureRmKeyVault -VaultName "ServerAdminPasswords" -ResourceGroupName "VaultRG" -Location local -verbose
	New-AzKeyVault -name AdminPasswords 

/* 
$projectName = Read-Host -Prompt "Enter a project name that is used for generating resource names"
$location = Read-Host -Prompt "Enter the location (i.e. centralus)"
$upn = Read-Host -Prompt "Enter your user principal name (email address) used to sign in to Azure"
$secretValue = Read-Host -Prompt "Enter the virtual machine administrator password" -AsSecureString

$resourceGroupName = "${projectName}rg"
$keyVaultName = $projectName
$adUserId = (Get-AzADUser -UserPrincipalName $upn).Id
$templateUri = "https://raw.githubusercontent.com/Azure/azure-docs-json-samples/master/tutorials-use-key-vault/CreateKeyVault.json"

New-AzResourceGroup -Name $resourceGroupName -Location $location
New-AzResourceGroupDeployment -ResourceGroupName $resourceGroupName -TemplateUri $templateUri -keyVaultName $keyVaultName -adUserId $adUserId -secretValue $secretValue
 */








$SecureString = convertto-securestring "Hi how are you?" -AsPlainText -Force

$SecureString = Get-AzKeyVaultSecret -vaultName mediumARMtemplateRGVault -name "adminPassword"
$BSTR = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($SecureString)
$PlainPassword = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($BSTR)
$PlainPassword



$SecureString = (Get-AzKeyVaultSecret -vaultName mediumARMtemplateRGVault -name "adminPassword").SecretValueText
$PlainPassword = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($SecureString)
$PlainPassword



$SecureString = Get-AzKeyVaultSecret -vaultName mediumARMtemplateRGVault -name "adminPassword"
$PlainPassword = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($SecureString)
$PlainPassword





"apiVersion": "2017-05-10",
      "name": "ServerTemplate",
      "type": "Microsoft.Resources/deployments",
      "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri":"https://pastebin.com/raw/sYjvEu2n",
            "contentVersion":"1.0.0.0"
          }
      }


"adminPassword": {
            "type": "securestring",
            "reference": {
                "keyVault": {
                    //"id": "/subscriptions/a637de61-4656-4056-9fb7-55d9026cf180/resourceGroups/WebServerVaultsRG/providers/Microsoft.KeyVault/vaults/MediumARMTemplateVault",
                    "id": "[resourceId('Microsoft.KeyVault/vaults', concat(resourceGroup().name, 'Vault'))]"   
                },
                "secretName": "WebServerAdminPW"
            }
        }




New-AzResourceGroupDeployment : 11:12:43 AM - Resource Microsoft.Compute/virtualMachines 'webserver1' failed with
message '{
  "error": {
    "details": [
      {
        "message": "Unexpected character encountered while parsing value: {. Path
'properties.osProfile.adminPassword', line 1, position 618.",
        "target": "vm.properties.osProfile.adminPassword"
      },
      {
        "message": "After parsing a value an unexpected character was encountered: :. Path
'properties.osProfile.adminPassword', line 1, position 624.",
        "target": "vm.properties.osProfile.adminPassword"
      },
      {
        "message": "After parsing a value an unexpected character was encountered: :. Path
'properties.osProfile.adminPassword', line 1, position 624.",
        "target": "vm.properties.osProfile.adminPassword"
      },
      {
        "message": "After parsing a value an unexpected character was encountered: :. Path
'properties.osProfile.adminPassword', line 1, position 624.",
        "target": "vm.properties.osProfile.adminPassword"
      }
    ],
    "code": "BadRequest",
    "message": "The request message is invalid."
  }
}'
At C:\Users\JohannesSöderbergEri\Documents\MediumArmTemplate\Deploy.ps1:36 char:1
+ New-AzResourceGroupDeployment -ResourceGroupName $rg -TemplateFile ~/ ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [New-AzResourceGroupDeployment], Exception
    + FullyQualifiedErrorId : Microsoft.Azure.Commands.ResourceManager.Cmdlets.Implementation.NewAzureResourceGroupDep
   loymentCmdlet

New-AzResourceGroupDeployment : 11:12:43 AM - Unexpected character encountered while parsing value: {. Path
'properties.osProfile.adminPassword', line 1, position 618.
At C:\Users\JohannesSöderbergEri\Documents\MediumArmTemplate\Deploy.ps1:36 char:1
+ New-AzResourceGroupDeployment -ResourceGroupName $rg -TemplateFile ~/ ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [New-AzResourceGroupDeployment], Exception
    + FullyQualifiedErrorId : Microsoft.Azure.Commands.ResourceManager.Cmdlets.Implementation.NewAzureResourceGroupDep
   loymentCmdlet

New-AzResourceGroupDeployment : 11:12:43 AM - After parsing a value an unexpected character was encountered: :. Path
'properties.osProfile.adminPassword', line 1, position 624.
At C:\Users\JohannesSöderbergEri\Documents\MediumArmTemplate\Deploy.ps1:36 char:1
+ New-AzResourceGroupDeployment -ResourceGroupName $rg -TemplateFile ~/ ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [New-AzResourceGroupDeployment], Exception
    + FullyQualifiedErrorId : Microsoft.Azure.Commands.ResourceManager.Cmdlets.Implementation.NewAzureResourceGroupDep
   loymentCmdlet

New-AzResourceGroupDeployment : 11:12:43 AM - After parsing a value an unexpected character was encountered: :. Path
'properties.osProfile.adminPassword', line 1, position 624.
At C:\Users\JohannesSöderbergEri\Documents\MediumArmTemplate\Deploy.ps1:36 char:1
+ New-AzResourceGroupDeployment -ResourceGroupName $rg -TemplateFile ~/ ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [New-AzResourceGroupDeployment], Exception
    + FullyQualifiedErrorId : Microsoft.Azure.Commands.ResourceManager.Cmdlets.Implementation.NewAzureResourceGroupDep
   loymentCmdlet

New-AzResourceGroupDeployment : 11:12:43 AM - After parsing a value an unexpected character was encountered: :. Path
'properties.osProfile.adminPassword', line 1, position 624.
At C:\Users\JohannesSöderbergEri\Documents\MediumArmTemplate\Deploy.ps1:36 char:1
+ New-AzResourceGroupDeployment -ResourceGroupName $rg -TemplateFile ~/ ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [New-AzResourceGroupDeployment], Exception
    + FullyQualifiedErrorId : Microsoft.Azure.Commands.ResourceManager.Cmdlets.Implementation.NewAzureResourceGroupDep
   loymentCmdlet

New-AzResourceGroupDeployment : 11:12:43 AM - Template output evaluation skipped: at least one resource deployment
operation failed. Please list deployment operations for details. Please see https://aka.ms/DeployOperations for usage
details.
At C:\Users\JohannesSöderbergEri\Documents\MediumArmTemplate\Deploy.ps1:36 char:1
+ New-AzResourceGroupDeployment -ResourceGroupName $rg -TemplateFile ~/ ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [New-AzResourceGroupDeployment], Exception
    + FullyQualifiedErrorId : Microsoft.Azure.Commands.ResourceManager.Cmdlets.Implementation.NewAzureResourceGroupDep
   loymentCmdlet

New-AzResourceGroupDeployment : 11:12:43 AM - Template output evaluation skipped: at least one resource deployment
operation failed. Please list deployment operations for details. Please see https://aka.ms/DeployOperations for usage
details.
At C:\Users\JohannesSöderbergEri\Documents\MediumArmTemplate\Deploy.ps1:36 char:1
+ New-AzResourceGroupDeployment -ResourceGroupName $rg -TemplateFile ~/ ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [New-AzResourceGroupDeployment], Exception
    + FullyQualifiedErrorId : Microsoft.Azure.Commands.ResourceManager.Cmdlets.Implementation.NewAzureResourceGroupDep
   loymentCmdlet

New-AzResourceGroupDeployment : 11:12:49 AM - Resource Microsoft.Resources/deployments 'ServerTemplate' failed with
message '{
  "status": "Failed",
  "error": {
    "code": "ResourceDeploymentFailure",
    "message": "The resource operation completed with terminal provisioning state 'Failed'.",
    "details": [
      {
        "code": "DeploymentFailed",
        "message": "At least one resource deployment operation failed. Please list deployment operations for details.
Please see https://aka.ms/DeployOperations for usage details.",
        "details": [
          {
            "code": "BadRequest",
            "message": "{\r\n  \"error\": {\r\n    \"details\": [\r\n      {\r\n        \"message\": \"Unexpected
character encountered while parsing value: {. Path 'properties.osProfile.adminPassword', line 1, position 618.\",\r\n
      \"target\": \"vm.properties.osProfile.adminPassword\"\r\n      },\r\n      {\r\n        \"message\": \"After
parsing a value an unexpected character was encountered: :. Path 'properties.osProfile.adminPassword', line 1,
position 624.\",\r\n        \"target\": \"vm.properties.osProfile.adminPassword\"\r\n      },\r\n      {\r\n
\"message\": \"After parsing a value an unexpected character was encountered: :. Path
'properties.osProfile.adminPassword', line 1, position 624.\",\r\n        \"target\":
\"vm.properties.osProfile.adminPassword\"\r\n      },\r\n      {\r\n        \"message\": \"After parsing a value an
unexpected character was encountered: :. Path 'properties.osProfile.adminPassword', line 1, position 624.\",\r\n
 \"target\": \"vm.properties.osProfile.adminPassword\"\r\n      }\r\n    ],\r\n    \"code\": \"BadRequest\",\r\n
\"message\": \"The request message is invalid.\"\r\n  }\r\n}"
          }
        ]
      }
    ]
  }
}'
At C:\Users\JohannesSöderbergEri\Documents\MediumArmTemplate\Deploy.ps1:36 char:1
+ New-AzResourceGroupDeployment -ResourceGroupName $rg -TemplateFile ~/ ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [New-AzResourceGroupDeployment], Exception
    + FullyQualifiedErrorId : Microsoft.Azure.Commands.ResourceManager.Cmdlets.Implementation.NewAzureResourceGroupDep
   loymentCmdlet

New-AzResourceGroupDeployment : 11:12:49 AM - At least one resource deployment operation failed. Please list
deployment operations for details. Please see https://aka.ms/DeployOperations for usage details.
At C:\Users\JohannesSöderbergEri\Documents\MediumArmTemplate\Deploy.ps1:36 char:1
+ New-AzResourceGroupDeployment -ResourceGroupName $rg -TemplateFile ~/ ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [New-AzResourceGroupDeployment], Exception
    + FullyQualifiedErrorId : Microsoft.Azure.Commands.ResourceManager.Cmdlets.Implementation.NewAzureResourceGroupDep
   loymentCmdlet

New-AzResourceGroupDeployment : 11:12:49 AM - Template output evaluation skipped: at least one resource deployment
operation failed. Please list deployment operations for details. Please see https://aka.ms/DeployOperations for usage
details.
At C:\Users\JohannesSöderbergEri\Documents\MediumArmTemplate\Deploy.ps1:36 char:1
+ New-AzResourceGroupDeployment -ResourceGroupName $rg -TemplateFile ~/ ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [New-AzResourceGroupDeployment], Exception
    + FullyQualifiedErrorId : Microsoft.Azure.Commands.ResourceManager.Cmdlets.Implementation.NewAzureResourceGroupDep
   loymentCmdlet

New-AzResourceGroupDeployment : 11:12:49 AM - Template output evaluation skipped: at least one resource deployment
operation failed. Please list deployment operations for details. Please see https://aka.ms/DeployOperations for usage
details.
At C:\Users\JohannesSöderbergEri\Documents\MediumArmTemplate\Deploy.ps1:36 char:1
+ New-AzResourceGroupDeployment -ResourceGroupName $rg -TemplateFile ~/ ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [New-AzResourceGroupDeployment], Exception
    + FullyQualifiedErrorId : Microsoft.Azure.Commands.ResourceManager.Cmdlets.Implementation.NewAzureResourceGroupDep
   loymentCmdlet



DeploymentName          : MainTemplate
ResourceGroupName       : MediumARMtemplateRG
ProvisioningState       : Failed
Timestamp               : 1/13/2020 10:12:51 AM
Mode                    : Incremental
TemplateLink            :
Parameters              :
                          Name             Type                       Value
                          ===============  =========================  ==========
                          projectName      String                     MediumARMtemplate
                          adminUsername    String                     serveradmin
                          adminPassword    SecureString
                          location         String                     northeurope
                          adUserId         String                     ab8db8c1-8adb-463b-ad3f-2582b69975d1

Outputs                 :
DeploymentDebugLogLevel :



PS C:\Users\JohannesSöderbergEri>


        "parameters": {
          "networkInterfaceName": {"value":"[concat('webServer', copyIndex(1), 'NetInterface')]"},
          "publicIpAddressName": {"value":"[concat('webServer', copyIndex(1), 'PubIp')]"},
          "virtualMachineName": {"value": "[concat('webServer', copyIndex(1))]"},
          "adminUsername": {"value":"[parameters('adminUsername')]"},
          "adminPassword": {"value":"[parameters('adminPassword')]"},
          "projectName": {"value":"[parameters('projectName')]"},
          "copyIndex": {"value": "[copyIndex(1)]"}




